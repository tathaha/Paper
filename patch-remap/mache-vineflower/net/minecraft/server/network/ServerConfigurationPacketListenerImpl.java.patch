--- a/net/minecraft/server/network/ServerConfigurationPacketListenerImpl.java
+++ b/net/minecraft/server/network/ServerConfigurationPacketListenerImpl.java
@@ -30,22 +30,24 @@
 import net.minecraft.server.network.config.ServerResourcePackConfigurationTask;
 import net.minecraft.server.players.PlayerList;
 import net.minecraft.tags.TagNetworkSerialization;
+import net.minecraft.util.thread.BlockableEventLoop;
 import net.minecraft.world.flag.FeatureFlags;
 import org.slf4j.Logger;
 
 public class ServerConfigurationPacketListenerImpl extends ServerCommonPacketListenerImpl implements TickablePacketListener, ServerConfigurationPacketListener {
+
     private static final Logger LOGGER = LogUtils.getLogger();
     private static final Component DISCONNECT_REASON_INVALID_DATA = Component.translatable("multiplayer.disconnect.invalid_player_data");
     private final GameProfile gameProfile;
-    private final Queue<ConfigurationTask> configurationTasks = new ConcurrentLinkedQueue<>();
+    private final Queue<ConfigurationTask> configurationTasks = new ConcurrentLinkedQueue();
     @Nullable
     private ConfigurationTask currentTask;
     private ClientInformation clientInformation;
 
-    public ServerConfigurationPacketListenerImpl(MinecraftServer minecraftServer, Connection connection, CommonListenerCookie commonListenerCookie) {
-        super(minecraftServer, connection, commonListenerCookie);
-        this.gameProfile = commonListenerCookie.gameProfile();
-        this.clientInformation = commonListenerCookie.clientInformation();
+    public ServerConfigurationPacketListenerImpl(MinecraftServer minecraftserver, Connection networkmanager, CommonListenerCookie commonlistenercookie, ServerPlayer player) { // CraftBukkit
+        super(minecraftserver, networkmanager, commonlistenercookie, player); // CraftBukkit
+        this.gameProfile = commonlistenercookie.gameProfile();
+        this.clientInformation = commonlistenercookie.clientInformation();
     }
 
     @Override
@@ -55,7 +57,7 @@
 
     @Override
     public void onDisconnect(Component reason) {
-        LOGGER.info("{} lost connection: {}", this.gameProfile, reason.getString());
+        ServerConfigurationPacketListenerImpl.LOGGER.info("{} lost connection: {}", this.gameProfile, reason.getString());
         super.onDisconnect(reason);
     }
 
@@ -66,14 +68,11 @@
 
     public void startConfiguration() {
         this.send(new ClientboundCustomPayloadPacket(new BrandPayload(this.server.getServerModName())));
-        LayeredRegistryAccess<RegistryLayer> layeredRegistryAccess = this.server.registries();
+        LayeredRegistryAccess<RegistryLayer> layeredregistryaccess = this.server.registries();
+
         this.send(new ClientboundUpdateEnabledFeaturesPacket(FeatureFlags.REGISTRY.toNames(this.server.getWorldData().enabledFeatures())));
-        this.send(
-            new ClientboundRegistryDataPacket(
-                new RegistryAccess.ImmutableRegistryAccess(RegistrySynchronization.networkedRegistries(layeredRegistryAccess)).freeze()
-            )
-        );
-        this.send(new ClientboundUpdateTagsPacket(TagNetworkSerialization.serializeTagsToNetwork(layeredRegistryAccess)));
+        this.send(new ClientboundRegistryDataPacket((new RegistryAccess.ImmutableRegistryAccess(RegistrySynchronization.networkedRegistries(layeredregistryaccess))).freeze()));
+        this.send(new ClientboundUpdateTagsPacket(TagNetworkSerialization.serializeTagsToNetwork(layeredregistryaccess)));
         this.addOptionalTasks();
         this.configurationTasks.add(new JoinWorldTask());
         this.startNextTask();
@@ -85,51 +84,56 @@
     }
 
     private void addOptionalTasks() {
-        this.server
-            .getServerResourcePack()
-            .ifPresent(serverResourcePackInfo -> this.configurationTasks.add(new ServerResourcePackConfigurationTask(serverResourcePackInfo)));
+        this.server.getServerResourcePack().ifPresent((minecraftserver_serverresourcepackinfo) -> {
+            this.configurationTasks.add(new ServerResourcePackConfigurationTask(minecraftserver_serverresourcepackinfo));
+        });
     }
 
     @Override
-    public void handleClientInformation(ServerboundClientInformationPacket serverboundClientInformationPacket) {
-        this.clientInformation = serverboundClientInformationPacket.information();
+    public void handleClientInformation(ServerboundClientInformationPacket serverboundclientinformationpacket) {
+        this.clientInformation = serverboundclientinformationpacket.information();
     }
 
     @Override
-    public void handleResourcePackResponse(ServerboundResourcePackPacket serverboundResourcePackPacket) {
-        super.handleResourcePackResponse(serverboundResourcePackPacket);
-        if (serverboundResourcePackPacket.action().isTerminal()) {
+    public void handleResourcePackResponse(ServerboundResourcePackPacket serverboundresourcepackpacket) {
+        super.handleResourcePackResponse(serverboundresourcepackpacket);
+        if (serverboundresourcepackpacket.action().isTerminal()) {
             this.finishCurrentTask(ServerResourcePackConfigurationTask.TYPE);
         }
+
     }
 
     @Override
-    public void handleConfigurationFinished(ServerboundFinishConfigurationPacket serverboundFinishConfigurationPacket) {
+    public void handleConfigurationFinished(ServerboundFinishConfigurationPacket serverboundfinishconfigurationpacket) {
         this.connection.suspendInboundAfterProtocolChange();
-        PacketUtils.ensureRunningOnSameThread(serverboundFinishConfigurationPacket, this, this.server);
+        PacketUtils.ensureRunningOnSameThread(serverboundfinishconfigurationpacket, this, (BlockableEventLoop) this.server);
         this.finishCurrentTask(JoinWorldTask.TYPE);
 
         try {
-            PlayerList playerList = this.server.getPlayerList();
-            if (playerList.getPlayer(this.gameProfile.getId()) != null) {
+            PlayerList playerlist = this.server.getPlayerList();
+
+            if (playerlist.getPlayer(this.gameProfile.getId()) != null) {
                 this.disconnect(PlayerList.DUPLICATE_LOGIN_DISCONNECT_MESSAGE);
                 return;
             }
 
-            Component component = playerList.canPlayerLogin(this.connection.getRemoteAddress(), this.gameProfile);
-            if (component != null) {
-                this.disconnect(component);
+            Component ichatbasecomponent = null; // CraftBukkit - login checks already completed
+
+            if (ichatbasecomponent != null) {
+                this.disconnect(ichatbasecomponent);
                 return;
             }
 
-            ServerPlayer playerForLogin = playerList.getPlayerForLogin(this.gameProfile, this.clientInformation);
-            playerList.placeNewPlayer(this.connection, playerForLogin, this.createCookie(this.clientInformation));
+            ServerPlayer entityplayer = playerlist.getPlayerForLogin(this.gameProfile, this.clientInformation, this.player); // CraftBukkit
+
+            playerlist.placeNewPlayer(this.connection, entityplayer, this.createCookie(this.clientInformation));
             this.connection.resumeInboundAfterProtocolChange();
-        } catch (Exception var5) {
-            LOGGER.error("Couldn't place player in world", (Throwable)var5);
-            this.connection.send(new ClientboundDisconnectPacket(DISCONNECT_REASON_INVALID_DATA));
-            this.connection.disconnect(DISCONNECT_REASON_INVALID_DATA);
+        } catch (Exception exception) {
+            ServerConfigurationPacketListenerImpl.LOGGER.error("Couldn't place player in world", exception);
+            this.connection.send(new ClientboundDisconnectPacket(ServerConfigurationPacketListenerImpl.DISCONNECT_REASON_INVALID_DATA));
+            this.connection.disconnect(ServerConfigurationPacketListenerImpl.DISCONNECT_REASON_INVALID_DATA);
         }
+
     }
 
     @Override
@@ -141,18 +145,21 @@
         if (this.currentTask != null) {
             throw new IllegalStateException("Task " + this.currentTask.type().id() + " has not finished yet");
         } else if (this.isAcceptingMessages()) {
-            ConfigurationTask configurationTask = this.configurationTasks.poll();
-            if (configurationTask != null) {
-                this.currentTask = configurationTask;
-                configurationTask.start(this::send);
+            ConfigurationTask configurationtask = (ConfigurationTask) this.configurationTasks.poll();
+
+            if (configurationtask != null) {
+                this.currentTask = configurationtask;
+                configurationtask.start(this::send);
             }
+
         }
     }
 
-    private void finishCurrentTask(ConfigurationTask.Type type) {
-        ConfigurationTask.Type type1 = this.currentTask != null ? this.currentTask.type() : null;
-        if (!type.equals(type1)) {
-            throw new IllegalStateException("Unexpected request for task finish, current task: " + type1 + ", requested: " + type);
+    private void finishCurrentTask(ConfigurationTask.a configurationtask_a) {
+        ConfigurationTask.a configurationtask_a1 = this.currentTask != null ? this.currentTask.type() : null;
+
+        if (!configurationtask_a.equals(configurationtask_a1)) {
+            throw new IllegalStateException("Unexpected request for task finish, current task: " + configurationtask_a1 + ", requested: " + configurationtask_a);
         } else {
             this.currentTask = null;
             this.startNextTask();
